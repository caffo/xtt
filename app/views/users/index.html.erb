<% box(:special, 'overview') do |box| %>
  <% box.title = "What are you doing?" %>
  <% box.content = capture do %>
    <% form_for current_user.statuses.build do |f| -%>
    <ul class="media-list">
      <li class="media-item status-form">
  			<%= f.text_area :message, :rows => 2, :cols => 55, :class => 'status-entry' %>
  			<p class="btns"><input type="image" src="/images/btns/ghost.png" class="btn" /></p>
      </li>
      <li class="media-item clearfix last">
        <div class="media">
          <%= gravatar_for current_user %>
        </div>
  		<% if current_user.last_status -%>
        <div class="media-content">
  			<% if current_user.last_status_project -%>
          <h4 class="media-title">
            <%= link_to_project current_user.last_status_project, "You're working on #{current_user.last_status_project.name}" %></h4>
  			<% end -%>
          <p class="quiet"><%=h current_user.last_status_message %></p>
          <span class="datetime">
            <%= link_to "more", current_user.last_status %> |
            <%= time_ago_in_words current_user.last_status_at %> ago</span>
        </div>
  		<% end -%>
      </li>
    </ul>
  	<% end -%>
  <% end %>
<% end %>

<% box(:normal, 'everyone') do |box| %>
  <% box.title = "What's everyone else doing?" %>
  <% box.content = capture do %>
    <ul id="timeline" class="media-list">
		<% current_user.related_users.each do |user| -%>
      <li class="media-item clearfix">
        <div class="media">
          <%= gravatar_for user %>
        </div>
        <div class="media-content">
          <h4 class="media-title"><a href="/video/2323"><%= link_to_user user %> <%= status_summary user.last_status_project %></a></h4>
          <p class="quiet"><%= status_for user %></p>
          <span class="datetime"><%= status_at user %></span>
        </div>
      </li>
		<% end -%>
    </ul>
  <% end #content %>
  <% box.footer = capture do %>
    <a href="#">5 other people haven't logged anything today &raquo;</a>
  <% end # footer %>
<% end %>
<%= yield :normal_box %>

<% box(:sidebar, 'projects') do |sbox| %>
  <% sbox.title = "Projects and time today" %>
  <% sbox.content_classes = "nopad" %>
  
  <% sbox.header_utils = capture do %>
    <div id="tool-tabs">
      <a href="#projectlist">Projects</a>
      <a href="#newproject">Create</a>
      <% if current_user.archived_projects %>
      <a href="#archived">Archived</a>
      <% end rescue '' %>
    </div>
  <% end %>
  
  <% content_for :dom_loaded do %>
	  new Control.Tabs("tool-tabs", {
	    linkSelector: 'a',
	    afterChange: function(container) {
	      var item = container.readAttribute('id');
	      if(item == "projectlist") {
	        $('sbox-projects').down('h3').update("Projects and time today");
	      } else if(item == "newproject") {
	        $('sbox-projects').down('h3').update("Add a new project");
	      }
	    }
	    });
	<% end %>
  
  <% sbox.content = capture do %>
  <div id="projectlist">
    <ul class="text-list" id="project-lists">
    <% if current_user.projects.any? %>
  	<% current_user.projects.each_with_index do |project, index| -%>
      <li<%= %( class="last") if first_in_collection?(current_user.projects, index) %> id="project-<%= project.id %>">
        <a href="<%= url_for project %>">
          <span class="ttl"><%=h project.name %></span>
          <span class="desc">Send messages using <em>@<%= project.code %></em></span>
          <span class="you">
            <span class="num"><%= number_with_precision current_user.project_hours[project.id].to_f, 2 %></span>
            <span class="meta">you</span>
          </span>
          <span class="others">
            <span class="num"><%= number_with_precision current_user.total_project_hours[project.id].to_f, 2 %></span>
            <span class="meta">others</span>
          </span>
        </a>
        <div id="showcase-project-<%= project.id %>" style="display:none">
          <h3>Edit <%= h(project.name) %></h3>
          <%= error_messages_for :project %>
            <% form_for project, :html => {:class => "form" } do |f| -%>
            <%= render :partial => "projects/form", :object => f %>
          <% end %>
        </div>
      </li>
  	<% end -%>
  	<% else %>
    	<% new_project_text = capture do %>
    	  <span class="ttl">You don't have any projects</span>
        <span class="desc">Create one now?</span>
    	<% end %>
  	<% end %>
    </ul>
  </div>
  
  <div id="newproject" style="padding:9px">
    <%= render :partial => '/projects/new' %>
  </div>
  <% end %>
<% end %>